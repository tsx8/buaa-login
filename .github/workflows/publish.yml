name: Manual Release

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  prepare-release:
    name: Prepare Version
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get_version.outputs.version }}
      tag_name: ${{ steps.get_version.outputs.tag_name }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Read VERSION file
        id: get_version
        run: |
          ver=$(cat VERSION | xargs)
          echo "Read version: $ver"
          
          tag="v$ver"
          
          echo "version=$ver" >> $GITHUB_OUTPUT
          echo "tag_name=$tag" >> $GITHUB_OUTPUT

  build-all:
    name: Build (${{ matrix.goos }}/${{ matrix.goarch }})
    needs: prepare-release
    runs-on: ubuntu-latest
    strategy:
      fail-fast: true
      matrix:
        include:
          - goos: linux
            goarch: amd64
          - goos: linux
            goarch: arm64
          - goos: windows
            goarch: amd64
          - goos: darwin
            goarch: amd64
          - goos: darwin
            goarch: arm64
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: 'stable'

      - name: Build and Package
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
          CGO_ENABLED: 0
          VERSION: ${{ needs.prepare-release.outputs.tag_name }}
        run: |
          BINARY_NAME="buaa-login"
          if [ "${{ matrix.goos }}" = "windows" ]; then
            BINARY_NAME="${BINARY_NAME}.exe"
          fi
          
          go build -ldflags "-s -w -X main.Version=${VERSION}" \
            -o "$BINARY_NAME" \
            ./cmd/buaa-login
          
          if [ "${{ matrix.goos }}" = "windows" ]; then
            ARCHIVE_NAME="buaa-login-${{ matrix.goos }}-${{ matrix.goarch }}.zip"
            zip "$ARCHIVE_NAME" "$BINARY_NAME"
          else
            ARCHIVE_NAME="buaa-login-${{ matrix.goos }}-${{ matrix.goarch }}.tar.gz"
            tar -czvf "$ARCHIVE_NAME" "$BINARY_NAME"
          fi
          
          mkdir dist
          mv "$ARCHIVE_NAME" dist/

      - name: Upload Artifacts for Release
        uses: actions/upload-artifact@v4
        with:
          name: release-assets-${{ matrix.goos }}-${{ matrix.goarch }}
          path: dist/*
          retention-days: 1

  create-release:
    name: Create & Publish Release
    needs: [prepare-release, build-all]
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create Git Tag
        run: |
          TAG_NAME="${{ needs.prepare-release.outputs.tag_name }}"

          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          
          # 如果标签已存在，先删除它（为了覆盖）
          if git rev-parse "$TAG_NAME" >/dev/null 2>&1; then
            echo "Tag exists, forcing update..."
            git tag -d "$TAG_NAME"
            git push origin :refs/tags/$TAG_NAME
          fi
          
          git tag $TAG_NAME
          git push origin $TAG_NAME

      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: release-assets-*
          path: all_assets
          merge-multiple: true

      - name: Display Downloaded Files
        run: ls -R all_assets

      - name: GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.prepare-release.outputs.tag_name }}
          name: Release ${{ needs.prepare-release.outputs.tag_name }}
          files: all_assets/*
          draft: false
          prerelease: false
          generate_release_notes: false
          make_latest: true
          fail_on_unmatched_files: true